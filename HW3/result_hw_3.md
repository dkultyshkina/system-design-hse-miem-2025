# Задание 3: Базы данных

- Взять ФТ и НФТ из HW_1
- Взять сервисы из HW_2
- Подумать какие БД будут под какие сценарии, описать сценарий выбора
- Описать дополнительно: репликация, шардинг

# Решение 

## ФТ и НФТ из HW_1

### Функциональные требования

Акторы: гости, сотрудники отеля

<br>

Домены системы: 
- бронирование;
- гостевой сервис;
- операционный менеджмент;
- аналитика;
- поддержка текущей инфраструктуры.

<br>

Данные:
- пользователей;
- о бронировании;
- состоянии номеров/других помещений отеля;
- операционные.

<br>

Функции:

Для гостей:

1. Онлайн-выбор номера:

- просмотр фотографий каждого номера;
- просмотр расположения номеров в отеле;
- фильтрация поиска.

Для персонала:

1. Система управления уборкой:

- приоритетные задания;
- просмотр всех заданий;
- просмотр расположения заданий для горничных;
- подтверждение выполнения задания.

2. Учёт информации о номерах отеля:

- сохранение статуса номера;
- информация и даты бронирования номеров.

### Нефункциональные требования

1. Производительность:

- время отклика меньше 2 секунд для 95% запросов;
- поддержка 500 одновременных пользователей.

2. Маштабируемость

- горизонтальное маштабирование (использование балансироващика нагрузки);
- горизонтальный и вертикальный шардинг БД.

3. Отказоустойчивость

- использование балансировщика нагрузки;
- каждая критически важная часть системы должна работать (как минимум) на двух физически распределенных серверах;
- бэкапы транзакций каждые 10 минут, восстановление работы после сбоя должно быть меньше 30 минут.
- резерное копирование.

4. Безопасность

- двухэтапная аутентификация;
- защита от хакерских атак;
- шифрование данных гостей.

5. Мониторинг

- сбор метрик;
- логирование системы;
- своевременность реагирования на проблемы в системе.

6. Регулярные требования

- требования по обработке персональных данных (Федеральный закон "О персональных данных" от 27.07.2006 N 152-ФЗ), например, хранение на серверах на территории РФ, получение согласия на обработку от пользователей, использование СКЗИ;
- интеграция с ЕГИС "МИР" для учета гостей;
- требования к договорам бронирования, турестической деятельности (Федеральный закон "Об основах туристской деятельности в Российской Федерации" от 24.11.1996 N 132-ФЗ).

7. Переносимость и совместимость системы

С текущими сервисами бронирования.

8. Пользовательский опыт

- минимальное количество действий для выполнения функций (например, бронирования или ознакомления со списком задач для уборки);
- предпочтения пользователя в бронирования и рекомендации;
- скорость работы и единство дизайна;
- выполнение функций без багов для бронирования номера, взаимодействия с сервисами гостя или для выполнения трудовых обязательств.

## Взять сервисы из HW_2

- Сервис авторизации и аутентификации 
- Сервис управления номерами 
- Сервис бронирования
- Сервис задач (для работников)
- Сервис отзывов
- Сервис уведомлений (для работников)
- Сервис аналитики

## Подумать какие БД будут под какие сценарии, описать сценарий выбора

<br>

| Сервис | Тип данных | Требования | Выбор | Обоснование |
|:-----------|:---:|:---:|:---:|------:|
| Сервис авторизации и аутентификации | Пользователи, сессии, токены | Высокая доступность, низкая задержка | PostgreSQL с репликацией | ACID для безопасности данных, репликация для отказоустойчивости, поддержка индексов для быстрого поиска |
| Сервис управления номерами | Метаданные номеров, статус, фото | Чтение быстрее записи, хранение расположения, фото | MongoDB (документная) | Гибкая схема для разных типов номеров, хранение фото |
| Сервис бронирования | Транзакции, даты | ACID, высокая согласованность | PostgreSQL с шардингом | Транзакционная модель критична для броней, шардинг по датам для масштабирования |
| Сервис задач | Задачи, логи выполнения | Высокая запись, даты | Cassandra | Оптимизация под временные ряды, высокая доступность |
| Сервис уведомлений | События, очереди сообщений | Очереди | Redis + Kafka | Redis для уведомлений в реальном времени, Kafka для надежной доставки |
| Сервис аналитики | Агрегированные данные | Аналитика, OLAP | ClickHouse | Оптимизирован для аналитических запросов |

## Описать дополнительно: репликация, шардинг

### Репликация

| Сервис | Выбор |	Тип репликации | Обоснование |
|-------:|:-----:|:---------------:|:------------|
| Бронирование, авторизация | PostgreSQL |	Синхронная	(1 мастер + 2 реплики) | Гарантия от потерь данных, реплики обслуживают запросы на чтение, мастер обслуживает запись |
| Управление номерами | MongoDB	| Replica Set 3 узла (1 primary + 2) | Автоматический failover, чтение с ближайшей реплики для снижения задержки |
| Задач | Cassandra | 3 реплики по DC (2 в основном, 1 в резервном) |  Гарантия от потерь данных |
| Уведомления | Redis |	1 мастер и 2 реплики |  Гарантия от потерь данных |
| Аналитики | ClickHouse | Синхронная | Гарантия от потерь данных |


### Шардинг

| Выбор | Критерий шардинга | Обоснование |
|------:|:-----------------:|:-----------:|
| PostgreSQL | По дате бронирования | Распределение нагрузки, упрощение хранения данных, для маштабирования при увеличении набора данных  |
| MongoDB	 | По диапазону номеров	 | Распределение нагрузки, для маштабирования при увеличении набора данных |
| Cassandra	 | По типу задачи        |	Распределение нагрузки и для маштабирования, для маштабирования при увеличении набора данных |
